Nuts and Bolts of WebSocket
===========================

## Introduction to WebSocket

* WebSocket introduction slides
* Chrome Developer Tools, Console
+
[source,text]
----
ws = new WebSocket("ws://echo.websocket.org");
ws.send("hello world");
----
+
* In Network tab, show WebSocket frames
* Define message handlers
+
[source, text]
----
ws.onmessage = function(evt) { console.log(evt) }
----
+
or
+
[source, text]
----
ws.onmessage = function(evt) { alert(evt.data) }
----
+
* Copy/paste fragment from websocket.org/echo.html
** Show Firefox Developer Tools
* Use http://caniuse.com/websockets to check WebSocket compatibility
* Talk points
** WebSocket server is required, just like HTTP
** Do you want to write your own WebSocket server or use that is already battle-tested ? For example, 200-line HTTP server is useful to begin with but production nginx or HTTPD are used in production

## Node.js

### Get started with OpenShift

. Create a new account https://www.openshift.com/app/account/new
. Install rhc client from https://developers.openshift.com/en/getting-started-client-tools.html

### Create your first NodeJS application on OpenShift

. Install NodeJS
. Create a NodeJS application on OpenShift
. `git clone <workspace>`
. `npm install` (will install the modules locally)
. `git add --all`
. `git commit`
. `git push`

### Echo server

. Copy the file from https://github.com/arun-gupta/nuts-and-bolts-of-websocket/blob/master/src/index.js
. `git add index.js`
. `npm install --save ws`
. `git add --all`
. `git commit`
. `git push`

#### Test the echo server

. Use http://www.websocket.org/echo.html
. Connect to ws://<appname>-<domain>.rhccloud.com:8000
. Send some messages and see the response

### WebSocket in OpenShift

image::images/openshift-websocket-routing.png[]

## JSR 356

### Introduction

Slides

### Chat Server

https://github.com/javaee-samples/javaee7-samples/tree/master/websocket/chat

#### Deploy to OpenShift

. In cloned repo `git rm -rf src pom.xml`
. `cp <chat dir>/target/chat.war deployments/ROOT.war`
. `git add deployments/ROOT.war`
. `git commit . -m"adding war"`
. `git push`

### Collaborative Whiteboard

https://github.com/javaee-samples/javaee7-samples/tree/master/websocket/whiteboard

#### Deploy locally to WildFly

. Download WildFly 8.1 http://download.jboss.org/wildfly/8.1.0.Final/wildfly-8.1.0.Final.zip
. Unzip and start as `bin/standalone.sh`
. Deploy the sample as `mvn wildfly:deploy` from whiteboard directory

### URI templating matching - message routing

https://github.com/javaee-samples/javaee7-samples/tree/master/websocket/parameters

### Client API

https://github.com/javaee-samples/javaee7-samples/tree/master/websocket/google-docs

### Programmatic endpoint

https://github.com/javaee-samples/javaee7-samples/tree/master/websocket/endpoint-singleton

## Securing WebSocket

### User-based security

. git clone https://github.com/javaee-samples/javaee7-samples/tree/master/websocket/endpoint-security
. Add a new user to WildFly
+
[source, text]
----
wildfly-8.1.0.Final> ./bin/add-user.sh -a -u u1 -p p1 -g g1
Added user 'u1' to file '/Users/arungupta/tools/wildfly-8.1.0.Final/standalone/configuration/application-users.properties'
Added user 'u1' to file '/Users/arungupta/tools/wildfly-8.1.0.Final/domain/configuration/application-users.properties'
Added user 'u1' with groups g1 to file '/Users/arungupta/tools/wildfly-8.1.0.Final/standalone/configuration/application-roles.properties'
Added user 'u1' with groups g1 to file '/Users/arungupta/tools/wildfly-8.1.0.Final/domain/configuration/application-roles.properties'
----
+
. `mvn wildfly:deploy`
. Access the application at http://localhost:8080/endpoint-security/, use `u1` username and `p1` password. All other values are incorrect.

### Over TLS

. Create keystore
+
[source, text]
----
keytool -genkey -alias websocket -keyalg RSA -keystore websocket.keystore -validity 10950
Enter keystore password:  
Re-enter new password: 
What is your first and last name?
  [Unknown]:  Arun Gupta
What is the name of your organizational unit?
  [Unknown]:  JBoss Middleware
What is the name of your organization?
  [Unknown]:  Red Hat
What is the name of your City or Locality?
  [Unknown]:  San Jose
What is the name of your State or Province?
  [Unknown]:  CA
What is the two-letter country code for this unit?
  [Unknown]:  US
Is CN=Arun Gupta, OU=JBoss Middleware, O=Red Hat, L=San Jose, ST=CA, C=US correct?
  [no]:  yes

Enter key password for <websocket>
	(RETURN if same as keystore password):  
Re-enter new password:
----
+
Use ``websocket'' as the password.
. Copy ``websocket.keystore'' in `standalone/configuration` directory.
. Add https-listener in `standalone/configuration/standalone.xml`
+
[source,text]
----
<https-listener name="default-https" socket-binding="https" security-realm="WebSocketRealm"/>
----
+
. Add the following `<security-realm>`
+
[source, text]
----
<security-realm name="WebSocketRealm">
	<server-identities>
    	<ssl protocol="TLS">
        	<keystore path="websocket.keystore" relative-to="jboss.server.config.dir" keystore-password="websocket"/>
        </ssl>
    </server-identities>
</security-realm>
----
+
. git clone https://github.com/javaee-samples/javaee7-samples/tree/master/websocket/endpoint-wss
. `mvn wildfly:deploy` to deploy on WildFly
. Access http://localhost:8080/endpoint-wss and notice how the request is redirected to https
. In `websocket.js`, change ``wss'' to ``ws'', deploy it again and look for the following error in Developer Tools Console:
+
[source, text]
----
Uncaught SecurityError: Failed to construct 'WebSocket': An insecure WebSocket connection may not be initiated from a page loaded over HTTPS.
----

## Embedded WebSocket using Undertow

. git clone git@github.com:undertow-io/undertow.git
. `mvn install` in the root
. `mvn exec:exec` in `examples' directory

## JBoss EAP 6.3

. Clone https://github.com/arun-gupta/wildfly-samples/tree/master/websocket-eap63
. Start EAP 6.3
. Setup NIO connector
+
[source. java]
----
./bin/jboss-cli.sh -c --command="/subsystem=web/connector=http/:write-attribute(name=protocol,value=org.apache.coyote.http11.Http11NioProtocol)
> 
jboss-eap-6.3> ./bin/jboss-cli.sh -c --command="/subsystem=web/connector=http/:write-attribute(name=protocol,value=org.apache.coyote.http11.Http11NioProtocol)"
{
    "outcome" => "success",
    "response-headers" => {
        "operation-requires-reload" => true,
        "process-state" => "reload-required"
    }
}
----
+
. Reload configuration
+
[source, java]
----
./bin/jboss-cli.sh -c --command="reload"
----
+
. mvn package jboss-as:deploy
. Access the application at http://localhost:8080/websocket-chat-1.0-SNAPSHOT/

## Load Balance

http://blog.arungupta.me/2014/08/load-balance-websockets-apache-httpd-techtip48/

## STOMP over WebSocket

. Provision ActiveMQ on OpenShift: https://github.com/arun-gupta/activemq-openshift-cartridge
. https://github.com/arun-gupta/wildfly-samples/tree/master/websocket-stomp
. Showcase http://demo.kaazing.com/demo/jms/javascript/?d=stomp-stock with ActiveMQ on OpenShift

## Pub/Sub over WebSocket

. Kaazing JMS Gateway
. https://github.com/arun-gupta/kaazing-openshift-cartridge
. Showcase http://demo.kaazing.com/demo/jms/javascript/jms-javascript.html

## Compare with REST

. https://github.com/javaee-samples/javaee7-samples/tree/master/websocket/websocket-vs-rest-payload
. https://github.com/javaee-samples/javaee7-samples/tree/master/websocket/websocket-vs-rest

## Compare with SSE

Slides

## MQTT over WebSocket

TBD

## WebSocket using Atmosphere

https://github.com/javaee-samples/javaee7-samples/tree/master/websocket/atmosphere-chat

## What makes them scalable ?

Slides

## WebSocket Debugging

Slides

## Production Tips

Slides

## Client technologies (supporting other languages - Java APIs or .NET APIs)

. Kaazing Client API
. Native App (Objective C and Java Android)

## Embedded and IoT

. Reveal the fun

## Cool demos

. http://twglobe-shifter.rhcloud.com/ using pubnub, pusher.io and twitter streaming API
. http://gist-reveal.it

